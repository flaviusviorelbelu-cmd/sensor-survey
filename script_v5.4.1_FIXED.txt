<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite Sensor Survey v5.4.1 - Enhanced Error Handling & CSV Import (FIXED)</title>
    <style>
/* SharePoint CSS Reset for Modal */
#addSatelliteModal *,
#importModal * {
    box-sizing: border-box;
}

#addSatelliteModal .modal-content,
#importModal .modal-content {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
}

/* Ensure modal is above SharePoint chrome */
.modal {
    z-index: 99999 !important;
}

/* Fix SharePoint suite bar interference */
#suiteBar,
#suiteBarDelta {
    z-index: 1000 !important;
}

        :root {
            --color-primary: #2180A3;
            --color-primary-hover: #1D6E80;
            --color-success: #32B8C6;
            --color-error: #C0152F;
            --color-warning: #A84B2F;
            --color-bg: #FCFCF9;
            --color-surface: #FFFFFF;
            --color-text: #134252;
            --color-text-secondary: #628076;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-shadow: rgba(0, 0, 0, 0.08);
            --radius: 8px;
            --spacing: 16px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing);
        }

        header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--spacing) 0;
            margin-bottom: var(--spacing);
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            color: var(--color-primary);
        }

        .header-subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing);
            margin-bottom: var(--spacing);
        }

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: var(--spacing);
            text-align: center;
            box-shadow: 0 2px 4px var(--color-shadow);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: var(--color-primary);
            margin: 8px 0;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toolbar {
            display: flex;
            gap: var(--spacing);
            margin-bottom: var(--spacing);
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            display: flex;
            gap: 8px;
        }

        .search-box input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            font-size: 14px;
            background: var(--color-surface);
            color: var(--color-text);
        }

        .search-box input::placeholder {
            color: var(--color-text-secondary);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 150ms ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            box-shadow: 0 4px 8px rgba(33, 128, 141, 0.2);
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        .btn-secondary:hover {
            background: rgba(33, 128, 141, 0.05);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing);
            margin-bottom: var(--spacing);
        }

        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: var(--spacing);
            box-shadow: 0 2px 4px var(--color-shadow);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing);
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 12px;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--color-primary);
        }

        .filter-group {
            display: flex;
            gap: 8px;
            margin-bottom: var(--spacing);
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 12px;
            transition: all 150ms ease;
            color: var(--color-text);
        }

        .filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .filter-btn:hover {
            border-color: var(--color-primary);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-surface);
        }

        thead {
            background: rgba(33, 128, 141, 0.08);
            border-bottom: 2px solid var(--color-border);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: var(--color-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: rgba(33, 128, 141, 0.12);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
            font-size: 13px;
        }

        tbody tr {
            transition: background 150ms ease;
        }

        tbody tr:hover {
            background: rgba(33, 128, 141, 0.04);
            cursor: pointer;
        }

        tbody tr.selected {
            background: rgba(33, 128, 141, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-operational {
            background: rgba(50, 184, 198, 0.2);
            color: var(--color-success);
        }

        .badge-testing {
            background: rgba(230, 129, 97, 0.2);
            color: var(--color-warning);
        }

        .badge-decommissioned {
            background: rgba(192, 21, 47, 0.2);
            color: var(--color-error);
        }

        .detail-view {
            display: grid;
            gap: 12px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 12px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--color-primary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            color: var(--color-text);
            font-size: 14px;
            word-break: break-word;
        }

        .sensors-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding-top: 6px;
        }

        .sensor-tag {
            background: rgba(33, 128, 141, 0.15);
            color: var(--color-primary);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
        }

       .modal {
    display: none;
    position: fixed;
    z-index: 99999;  /* Changed from 1000 to 99999 to be above SharePoint */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.65);  /* Darker backdrop */
    overflow: auto;
    backdrop-filter: blur(2px);  /* Add blur effect */
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: var(--color-surface);
    padding: 24px;  /* Increased padding */
    border-radius: var(--radius);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);  /* Stronger shadow */
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;  /* Added */
    z-index: 100000;  /* Above modal backdrop */
}


        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing);
            padding-bottom: var(--spacing);
            border-bottom: 1px solid var(--color-border);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--color-primary);
        }

        .modal h2 {
            margin-top: 0;
            margin-bottom: var(--spacing);
            color: var(--color-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        .modal-close:hover {
            color: var(--color-text);
        }

        .form-group {
            margin-bottom: var(--spacing);
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--color-text);
            font-size: 13px;
        }

        .form-group.required label::after {
            content: ' *';
            color: var(--color-error);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: inherit;
            color: var(--color-text);
            background: var(--color-surface);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1);
        }

        .form-group input.error,
        .form-group textarea.error,
        .form-group select.error {
            border-color: var(--color-error);
            background-color: rgba(192, 21, 47, 0.05);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: var(--spacing);
        }

        .form-actions button {
            flex: 1;
        }

        .modal-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: var(--spacing);
            padding-top: var(--spacing);
            border-top: 1px solid var(--color-border);
        }

        .empty-state {
            text-align: center;
            padding: 40px var(--spacing);
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(33, 128, 141, 0.2);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: var(--spacing);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 300ms ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: rgba(50, 184, 198, 0.1);
            color: var(--color-success);
            border: 1px solid rgba(50, 184, 198, 0.3);
        }

        .alert-error {
            background: rgba(192, 21, 47, 0.1);
            color: var(--color-error);
            border: 1px solid rgba(192, 21, 47, 0.3);
        }

        .alert-info {
            background: rgba(33, 128, 141, 0.1);
            color: var(--color-primary);
            border: 1px solid rgba(33, 128, 141, 0.3);
        }

        .alert-warning {
            background: rgba(230, 129, 97, 0.1);
            color: var(--color-warning);
            border: 1px solid rgba(230, 129, 97, 0.3);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--color-border);
            margin-bottom: var(--spacing);
            gap: 4px;
        }

        .tab-btn {
            padding: 12px 16px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            font-weight: 500;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            transition: all 150ms ease;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .validation-error {
            color: var(--color-error);
            font-size: 12px;
            margin-top: 4px;
            display: block;
            min-height: 16px;
        }

        .storage-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            background: rgba(50, 184, 198, 0.15);
            color: var(--color-success);
        }

        .csv-info {
            background: rgba(33, 128, 141, 0.05);
            border: 1px solid rgba(33, 128, 141, 0.2);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: var(--spacing);
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .csv-info strong {
            color: var(--color-primary);
        }

        .import-preview {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 12px;
            margin-top: 12px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }

        .import-preview table {
            font-size: 12px;
        }

        .import-preview th,
        .import-preview td {
            padding: 6px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 4px 8px;
            font-size: 11px;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üõ∞Ô∏è Satellite Sensor Survey v5.4.1</h1>
            <p class="header-subtitle">Enhanced Error Handling & Real-time satellite and sensor management with CSV import <span class="storage-indicator" id="storageIndicator">Local Storage Mode</span></p>
        </div>
    </header>

    <main class="container">
        <!-- Alerts -->
        <div id="alertContainer"></div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Satellites</div>
                <div class="stat-value" id="statSatellites">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Sensors</div>
                <div class="stat-value" id="statSensors">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Operational</div>
                <div class="stat-value" id="statOperational">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Constellations</div>
                <div class="stat-value" id="statConstellations">0</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search satellites, sensors, or NORAD IDs...">
            </div>
            <button type="button" class="btn btn-primary" onclick="showAddSatelliteModal(); return false;">+ Add Satellite</button>
            <button type="button" class="btn btn-secondary" onclick="showImportModal(); return false;">üì§ Import CSV</button>
            <button type="button" class="btn btn-secondary" onclick="exportToCSV(); return false;">üì• Export</button>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Satellites Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>Satellites</h2>
                    <span id="satelliteCount">0</span>
                </div>

                <div class="tabs">
                    <button type="button" class="tab-btn active" onclick="switchTab('satellites', 'sat-all'); return false;">All</button>
                    <button type="button" class="tab-btn" onclick="switchTab('satellites', 'sat-operational'); return false;">Operational</button>
                    <button type="button" class="tab-btn" onclick="switchTab('satellites', 'sat-leo'); return false;">LEO</button>
                    <button type="button" class="tab-btn" onclick="switchTab('satellites', 'sat-geo'); return false;">GEO</button>
                </div>

                <div class="table-wrapper">
                    <table id="satelliteTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('satellites', 'Title')">Name ‚Üï</th>
                                <th onclick="sortTable('satellites', 'NORAD_ID')">NORAD ID ‚Üï</th>
                                <th>Status</th>
                                <th>Orbit</th>
                                <th style="width: 80px; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="satelliteTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #999;">
                                    <div class="loading"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sensors Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>Sensors</h2>
                    <span id="sensorCount">0</span>
                </div>

                <div class="tabs">
                    <button type="button" class="tab-btn active" onclick="switchTab('sensors', 'sen-all'); return false;">All</button>
                    <button type="button" class="tab-btn" onclick="switchTab('sensors', 'sen-eo'); return false;">EO</button>
                    <button type="button" class="tab-btn" onclick="switchTab('sensors', 'sen-ir'); return false;">IR</button>
                    <button type="button" class="tab-btn" onclick="switchTab('sensors', 'sen-sar'); return false;">SAR</button>
                </div>

                <div class="table-wrapper">
                    <table id="sensorTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('sensors', 'Title')">Name ‚Üï</th>
                                <th>Type</th>
                                <th>Satellites</th>
                            </tr>
                        </thead>
                        <tbody id="sensorTableBody">
                            <tr>
                                <td colspan="3" style="text-align: center; color: #999;">
                                    <div class="loading"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Detail View -->
        <div class="panel">
            <div class="panel-header">
                <h2 id="detailTitle">Satellite Details</h2>
                <div id="detailActions"></div>
            </div>
            <div id="detailContent" class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <p>Select a satellite or sensor to view details</p>
            </div>
        </div>
    </main>

    <!-- Add/Edit Satellite Modal -->
    <div id="addSatelliteModal" class="modal" onclick="handleModalBackdropClick(event); return false;">
        <div class="modal-content" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Satellite</h3>
                <button type="button" class="modal-close" onclick="closeAddSatelliteModal(); return false;">√ó</button>
            </div>
            
            <form id="satelliteForm" onsubmit="saveSatellite(event); return false;">
                <div class="form-group required">
                    <label for="satellite-title">Satellite Name</label>
                    <input 
                        type="text" 
                        id="satellite-title"
                        name="Title" 
                        placeholder="Enter satellite name"
                        maxlength="255"
                    >
                    <div class="validation-error" id="error-title"></div>
                </div>

                <div class="form-group required">
    <label for="satellite-norad">NORAD ID</label>
    <input 
        type="number" 
        id="satellite-norad"
        name="NORAD_ID" 
        placeholder="Enter NORAD ID"
        step="1"
        min="0"
    >
    <div class="validation-error" id="error-norad"></div>
</div>

                    <div class="validation-error" id="error-norad"></div>
                </div>

                <div class="form-group">
                    <label for="satellite-cospar">COSPAR ID</label>
                    <input 
                        type="text" 
                        id="satellite-cospar"
                        name="COSPAR_ID" 
                        placeholder="e.g., 2013-008A"
                        maxlength="20"
                    >
                    <div class="validation-error" id="error-cospar"></div>
                </div>

                <div class="form-group">
                    <label for="satellite-mission">Mission Type</label>
                    <input 
                        type="text" 
                        id="satellite-mission"
                        name="Mission_Type" 
                        placeholder="e.g., Earth Observation"
                        maxlength="100"
                    >
                </div>

                <div class="form-group">
                    <label for="satellite-status">Status</label>
                    <select id="satellite-status" name="Status">
                        <option value="Operational">Operational</option>
                        <option value="Non-operational">Non-operational</option>
                        <option value="Partially operational">Partially operational</option>
                        <option value="Unknown">Unknown</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="satellite-orbit">Orbit Type</label>
                    <select id="satellite-orbit" name="Orbit_Type">
                        <option value="">-- Select --</option>
                        <option value="LEO">LEO</option>
                        <option value="MEO">MEO</option>
                        <option value="GEO">GEO</option>
                        <option value="SSO">SSO</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="satellite-launch">Launch Date</label>
                    <input 
                        type="date" 
                        id="satellite-launch"
                        name="Launch_Date"
                    >
                    <div class="validation-error" id="error-launch"></div>
                </div>

                <div class="form-group">
                    <label for="satellite-sensors">Sensor Names</label>
                    <textarea 
                        id="satellite-sensors"
                        name="Sensor_Names" 
                        rows="3"
                        placeholder="Comma-separated sensor names"
                        maxlength="500"
                    ></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Satellite</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddSatelliteModal(); return false;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div id="importModal" class="modal" onclick="handleImportModalBackdropClick(event); return false;">
        <div class="modal-content" onclick="event.stopPropagation();">
            <div class="modal-header">
                <h3>Import Satellites from CSV</h3>
                <button type="button" class="modal-close" onclick="closeImportModal(); return false;">√ó</button>
            </div>
            
            <div class="csv-info">
                <strong>CSV Format:</strong> Your file should have these columns:<br>
                Title, NORAD_ID, COSPAR_ID, Mission_Type, Status, Orbit_Type, Launch_Date, Sensor_Names
            </div>

            <form id="importForm" onsubmit="handleCSVImport(event); return false;">
                <div class="form-group">
                    <label for="csvFile">Choose CSV File</label>
                    <input 
                        type="file" 
                        id="csvFile" 
                        name="csvFile" 
                        accept=".csv"
                    >
                    <div class="validation-error" id="error-csv"></div>
                </div>

                <div id="importPreview" class="import-preview" style="display:none;"></div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Import Data</button>
                    <button type="button" class="btn btn-secondary" onclick="closeImportModal(); return false;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================================================
        // SATELLITE SENSOR SURVEY v5.4.1 - FIXED DOM ELEMENT ACCESS
        // ============================================================================

        // Configuration
        const config = {
            satelliteList: 'Satellite_Fixed',
            sensorList: 'Sensor',
            useMultiSelectChoice: false,
            inSharePoint: typeof _spPageContextInfo !== 'undefined' && 
                         _spPageContextInfo && 
                         _spPageContextInfo.webAbsoluteUrl ? true : false,
            siteUrl: typeof _spPageContextInfo !== 'undefined' && 
                    _spPageContextInfo && 
                    _spPageContextInfo.webAbsoluteUrl ? _spPageContextInfo.webAbsoluteUrl : '',
            apiTimeout: 30000
        };

        // State
        const state = {
            satellites: [],
            sensors: [],
            filteredSatellites: [],
            filteredSensors: [],
            selectedSatellite: null,
            selectedSensor: null,
            searchTerm: '',
            sortColumn: 'Title',
            sortDirection: 'asc',
            currentFilter: 'all',
            editingId: null,
            csvPreviewData: [],
            nextId: 1000
        };

        // Logger
        const Logger = {
            log: function(msg) { console.log('[INFO]', msg); },
            error: function(msg, data) { console.error('[ERROR]', msg, data || ''); },
            warn: function(msg) { console.warn('[WARN]', msg); }
        };

        // ============================================================================
        // SAFE DOM ELEMENT ACCESS - DEFERRED UNTIL DOM READY
        // ============================================================================

        function safeGetElement(id) {
            try {
                const el = document.getElementById(id);
                if (!el) {
                    Logger.warn(`Element not found: id: '${id}'`);
                    return null;
                }
                return el;
            } catch (e) {
                Logger.error(`Error accessing element '${id}'`, e.message);
                return null;
            }
        }

        function safeSetEventListener(elementId, eventType, handler) {
            const el = safeGetElement(elementId);
            if (el && handler) {
                try {
                    el.addEventListener(eventType, handler);
                    Logger.log(`‚úÖ Event listener attached: ${elementId}`);
                } catch (e) {
                    Logger.error(`Failed to attach event to ${elementId}`, e.message);
                }
            }
        }

        // ============================================================================
        // LOCAL STORAGE
        // ============================================================================

        function saveToLocalStorage() {
            try {
                localStorage.setItem('satellites_data', JSON.stringify(state.satellites));
                localStorage.setItem('nextId', state.nextId.toString());
                Logger.log('‚úÖ Data saved to localStorage');
            } catch (e) {
                Logger.error('Failed to save to localStorage', e.message);
                showAlert('‚ö†Ô∏è  Warning: Could not save to browser storage', 'warning');
            }
        }

        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('satellites_data');
                if (stored) {
                    state.satellites = JSON.parse(stored);
                    Logger.log('‚úÖ Data loaded from localStorage: ' + state.satellites.length);
                } else {
                    Logger.log('‚ÑπÔ∏è No stored data found');
                }
                const id = localStorage.getItem('nextId');
                if (id) state.nextId = parseInt(id);
            } catch (e) {
                Logger.error('Failed to load from localStorage', e.message);
                state.satellites = [];
            }
        }

        // ============================================================================
        // INITIALIZE WHEN DOM IS READY
        // ============================================================================

        document.addEventListener('DOMContentLoaded', function() {
            Logger.log('üöÄ Initializing Satellite Sensor Survey v5.4.1');
            Logger.log('SharePoint Mode: ' + (config.inSharePoint ? 'YES' : 'NO'));

            try {
                // Update indicator
                const indicator = safeGetElement('storageIndicator');
                if (indicator) {
                    if (config.inSharePoint) {
                        indicator.textContent = 'SharePoint Mode (Connected)';
                        indicator.style.background = 'rgba(50, 184, 198, 0.15)';
                    } else {
                        indicator.textContent = 'Local Storage Mode';
                        indicator.style.background = 'rgba(230, 129, 97, 0.15)';
                    }
                }

                // Load data
                if (config.inSharePoint && config.siteUrl) {
                    loadSatellites();
                } else {
                    loadFromLocalStorage();
                    if (state.satellites.length === 0) {
                        state.satellites = [
                            { ID: 1, Title: 'Landsat 8', NORAD_ID: '39084', COSPAR_ID: '2013-008A', Mission_Type: 'Earth Observation', Status: 'Operational', Orbit_Type: 'SSO', Launch_Date: '2013-02-11', Expected_Lifetime: 10, Constellation_ID: 1, Sensor_Names: 'Multispectral Imager', Primary_Sensor: 'Multispectral Imager' }
                        ];
                        state.nextId = 1001;
                        saveToLocalStorage();
                        showAlert('üìä Loaded with sample data', 'info');
                    } else {
                        showAlert('‚úÖ Loaded ' + state.satellites.length + ' satellites', 'success');
                    }
                }

                loadSensors();

                // NOW attach event listeners (DOM is fully ready)
                attachAllEventListeners();

                // Initial render
                filterAndDisplayData();
                updateStatistics();
                Logger.log('‚úÖ Initialization complete');

            } catch (e) {
                Logger.error('Fatal initialization error', e.message);
                showAlert('‚ùå Error during initialization', 'error');
            }
        });

        // ============================================================================
        // ATTACH ALL EVENT LISTENERS AT ONCE (AFTER DOM READY)
        // ============================================================================

        function attachAllEventListeners() {
    Logger.log('üîó Attaching all event listeners...');

    try {
        // Search input
        const searchInput = safeGetElement('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                state.searchTerm = e.target.value.toLowerCase();
                filterAndDisplayData();
            });
            Logger.log('‚úÖ Search listener attached');
        }

        // CSV file input
        const csvFile = safeGetElement('csvFile');
        if (csvFile) {
            csvFile.addEventListener('change', handleCSVFileSelect);
            Logger.log('‚úÖ CSV file listener attached');
        }

        // Import form
        const importForm = safeGetElement('importForm');
        if (importForm) {
            importForm.addEventListener('submit', (e) => handleCSVImport(e));
            Logger.log('‚úÖ Import form listener attached');
        }

        // CRITICAL FIX: Use event delegation for modal backdrop clicks
        document.addEventListener('click', (e) => {
            if (e.target.id === 'addSatelliteModal') {
                closeAddSatelliteModal();
            }
            if (e.target.id === 'importModal') {
                closeImportModal();
            }
        });

        // CRITICAL FIX: Attach form handler using event delegation
        // This works even if the form doesn't exist yet
        document.addEventListener('submit', (e) => {
            if (e.target.id === 'satelliteForm') {
                e.preventDefault();
                saveSatellite(e);
                Logger.log('üìù Form submitted via event delegation');
            }
        });
        Logger.log('‚úÖ Form handler attached via delegation');

        // Document-level event delegation for edit/delete buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-btn')) {
                e.preventDefault();
                const id = parseInt(e.target.dataset.id);
                if (!isNaN(id)) {
                    Logger.log('‚úèÔ∏è Edit clicked for ID: ' + id);
                    editSatellite(id);
                }
            }
            if (e.target.classList.contains('delete-btn')) {
                e.preventDefault();
                const id = parseInt(e.target.dataset.id);
                if (!isNaN(id)) {
                    Logger.log('üóëÔ∏è Delete clicked for ID: ' + id);
                    deleteSatellite(id);
                }
            }
        });
        Logger.log('‚úÖ Edit/Delete listeners attached via delegation');

        Logger.log('‚úÖ All event listeners attached successfully');
    } catch (e) {
        Logger.error('Error attaching event listeners', e.message);
    }
}


        // ============================================================================
        // SHAREPOINT DATA LOADING
        // ============================================================================

        async function loadSatellites() {
            if (!config.inSharePoint || !config.siteUrl) return;

            try {
                const url = config.siteUrl + 
                    `/_api/web/lists/getbytitle('${config.satelliteList}')/items?$top=5000`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json;odata=verbose' },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    state.satellites = data.d.results.map(item => ({
                        ID: item.ID,
                        Title: item.Title || '',
                        NORAD_ID: item.NORAD_ID || '',
                        COSPAR_ID: item.COSPAR_ID || '',
                        Mission_Type: item.Mission_Type || '',
                        Status: item.Status || 'Operational',
                        Orbit_Type: item.Orbit_Type || '',
                        Launch_Date: item.Launch_Date ? new Date(item.Launch_Date).toISOString().split('T')[0] : '',
                        Expected_Lifetime: item.Expected_Lifetime || '',
                        Constellation_ID: item.Constellation_ID || '',
                        Sensor_Names: item.Sensor_Names || '',
                        Primary_Sensor: item.Primary_Sensor || ''
                    }));
                    Logger.log('‚úÖ Satellites loaded from SharePoint: ' + state.satellites.length);
                    showAlert('‚úÖ Loaded ' + state.satellites.length + ' satellites', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (e) {
                Logger.error('Error loading satellites', e.message);
                showAlert('‚ùå Error loading satellites: ' + e.message, 'error');
            }
        }

        async function loadSensors() {
            if (!config.inSharePoint || !config.siteUrl) {
                state.sensors = [];
                return;
            }

            try {
                const url = config.siteUrl + 
                    `/_api/web/lists/getbytitle('${config.sensorList}')/items?$top=5000`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json;odata=verbose' },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    state.sensors = data.d.results.map(item => ({
                        ID: item.ID,
                        Title: item.Title || '',
                        Sensor_Type: item.Sensor_Type || '',
                        Description: item.Description || '',
                        Satellite_Names: item.Satellite_Names || ''
                    }));
                    Logger.log('‚úÖ Sensors loaded: ' + state.sensors.length);
                }
            } catch (e) {
                Logger.error('Error loading sensors', e.message);
                state.sensors = [];
            }
        }

        // ============================================================================
        // FILTERING & DISPLAY
        // ============================================================================

        function filterAndDisplayData() {
            state.filteredSatellites = state.satellites.filter(sat => {
                const match = !state.searchTerm ||
                    (sat.Title && sat.Title.toLowerCase().includes(state.searchTerm)) ||
                    (sat.NORAD_ID && sat.NORAD_ID.toString().includes(state.searchTerm));

                if (state.currentFilter === 'sat-operational') return match && sat.Status === 'Operational';
                if (state.currentFilter === 'sat-leo') return match && sat.Orbit_Type === 'LEO';
                if (state.currentFilter === 'sat-geo') return match && sat.Orbit_Type === 'GEO';
                return match;
            });

            state.filteredSensors = state.sensors.filter(sen => {
                const match = !state.searchTerm ||
                    (sen.Title && sen.Title.toLowerCase().includes(state.searchTerm));

                if (state.currentFilter === 'sen-eo') return match && sen.Sensor_Type === 'EO';
                if (state.currentFilter === 'sen-ir') return match && sen.Sensor_Type === 'IR';
                if (state.currentFilter === 'sen-sar') return match && sen.Sensor_Type === 'SAR';
                return match;
            });

            renderSatelliteTable();
            renderSensorTable();

            const satCountEl = safeGetElement('satelliteCount');
            const senCountEl = safeGetElement('sensorCount');
            if (satCountEl) satCountEl.textContent = state.filteredSatellites.length;
            if (senCountEl) senCountEl.textContent = state.filteredSensors.length;
        }

        function renderSatelliteTable() {
            const tbody = safeGetElement('satelliteTableBody');
            if (!tbody) return;

            if (state.filteredSatellites.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No satellites found</td></tr>';
                return;
            }

            tbody.innerHTML = state.filteredSatellites.map(sat => `
                <tr onclick="selectSatellite(${sat.ID})" class="${state.selectedSatellite?.ID === sat.ID ? 'selected' : ''}">
                    <td><strong>${escapeHtml(sat.Title)}</strong></td>
                    <td>${escapeHtml(sat.NORAD_ID)}</td>
                    <td><span class="badge badge-operational">${escapeHtml(sat.Status)}</span></td>
                    <td>${escapeHtml(sat.Orbit_Type)}</td>
                    <td style="text-align: center;">
                        <button class="btn btn-small btn-secondary edit-btn" data-id="${sat.ID}" title="Edit">‚úèÔ∏è</button>
                        <button class="btn btn-small btn-secondary delete-btn" data-id="${sat.ID}" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderSensorTable() {
            const tbody = safeGetElement('sensorTableBody');
            if (!tbody) return;

            if (state.filteredSensors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">No sensors found</td></tr>';
                return;
            }

            tbody.innerHTML = state.filteredSensors.map(sen => `
                <tr onclick="selectSensor(${sen.ID})" class="${state.selectedSensor?.ID === sen.ID ? 'selected' : ''}">
                    <td><strong>${escapeHtml(sen.Title)}</strong></td>
                    <td>${escapeHtml(sen.Sensor_Type)}</td>
                    <td>${(sen.Satellite_Names || '').split(',').filter(s => s.trim()).length}</td>
                </tr>
            `).join('');
        }

        // ============================================================================
        // DETAIL VIEWS
        // ============================================================================

        function selectSatellite(id) {
            const sat = state.satellites.find(s => s.ID === id);
            if (!sat) return;

            state.selectedSatellite = sat;
            state.selectedSensor = null;
            renderSatelliteDetail();
            filterAndDisplayData();
        }

        function selectSensor(id) {
            const sen = state.sensors.find(s => s.ID === id);
            if (!sen) return;

            state.selectedSensor = sen;
            state.selectedSatellite = null;
            renderSensorDetail();
            filterAndDisplayData();
        }

        function renderSatelliteDetail() {
            const sat = state.selectedSatellite;
            const sensors = (sat.Sensor_Names || '').split(',').map(s => s.trim()).filter(s => s);

            const html = `
                <div class="detail-view">
                    <div class="detail-row"><div class="detail-label">Name</div><div class="detail-value">${escapeHtml(sat.Title)}</div></div>
                    <div class="detail-row"><div class="detail-label">NORAD ID</div><div class="detail-value">${escapeHtml(sat.NORAD_ID)}</div></div>
                    <div class="detail-row"><div class="detail-label">COSPAR ID</div><div class="detail-value">${escapeHtml(sat.COSPAR_ID) || 'N/A'}</div></div>
                    <div class="detail-row"><div class="detail-label">Status</div><div class="detail-value"><span class="badge badge-operational">${escapeHtml(sat.Status)}</span></div></div>
                    <div class="detail-row"><div class="detail-label">Mission</div><div class="detail-value">${escapeHtml(sat.Mission_Type) || 'N/A'}</div></div>
                    <div class="detail-row"><div class="detail-label">Orbit</div><div class="detail-value">${escapeHtml(sat.Orbit_Type) || 'N/A'}</div></div>
                    <div class="detail-row"><div class="detail-label">Launch</div><div class="detail-value">${escapeHtml(sat.Launch_Date) || 'N/A'}</div></div>
                </div>
            `;

            const title = safeGetElement('detailTitle');
            const content = safeGetElement('detailContent');
            const actions = safeGetElement('detailActions');

            if (title) title.textContent = `Satellite: ${sat.Title}`;
            if (content) content.innerHTML = html;
            if (actions) actions.innerHTML = `
                <button type="button" class="btn btn-small btn-secondary" onclick="editSatellite(${sat.ID}); return false;">Edit</button>
                <button type="button" class="btn btn-small btn-secondary" onclick="deleteSatellite(${sat.ID}); return false;">Delete</button>
            `;
        }

        function renderSensorDetail() {
            const sen = state.selectedSensor;
            const html = `
                <div class="detail-view">
                    <div class="detail-row"><div class="detail-label">Name</div><div class="detail-value">${escapeHtml(sen.Title)}</div></div>
                    <div class="detail-row"><div class="detail-label">Type</div><div class="detail-value">${escapeHtml(sen.Sensor_Type) || 'N/A'}</div></div>
                    <div class="detail-row"><div class="detail-label">Description</div><div class="detail-value">${escapeHtml(sen.Description) || 'N/A'}</div></div>
                </div>
            `;

            const title = safeGetElement('detailTitle');
            const content = safeGetElement('detailContent');
            const actions = safeGetElement('detailActions');

            if (title) title.textContent = `Sensor: ${sen.Title}`;
            if (content) content.innerHTML = html;
            if (actions) actions.innerHTML = '';
        }

        // ============================================================================
        // CRUD OPERATIONS
        // ============================================================================

        function showAddSatelliteModal() {
            clearValidationErrors();
            const form = safeGetElement('satelliteForm');
            if (form) form.reset();
            
            const title = safeGetElement('modalTitle');
            if (title) title.textContent = 'Add New Satellite';
            
            state.editingId = null;
            const modal = safeGetElement('addSatelliteModal');
            if (modal) modal.classList.add('active');
            return false;
        }

        function closeAddSatelliteModal() {
    const modal = safeGetElement('addSatelliteModal');
    if (modal) modal.classList.remove('active');
    
    const form = safeGetElement('satelliteForm');
    if (form) form.reset();
    
    clearValidationErrors();
    state.editingId = null;
    
    // Re-enable body scroll
    document.body.style.overflow = '';
    
    return false;
}

function showAddSatelliteModal() {
    clearValidationErrors();
    const form = safeGetElement('satelliteForm');
    if (form) form.reset();
    
    const title = safeGetElement('modalTitle');
    if (title) title.textContent = 'Add New Satellite';
    
    state.editingId = null;
    const modal = safeGetElement('addSatelliteModal');
    if (modal) {
        modal.classList.add('active');
        
        // Prevent body scroll when modal is open
        document.body.style.overflow = 'hidden';
        
        // Focus first input field
        setTimeout(() => {
            const firstInput = safeGetElement('satellite-title');
            if (firstInput) firstInput.focus();
        }, 100);
    }
    return false;
}

        function handleModalBackdropClick(event) {
            if (event.target.id === 'addSatelliteModal') closeAddSatelliteModal();
            return false;
        }

        function handleImportModalBackdropClick(event) {
            if (event.target.id === 'importModal') closeImportModal();
            return false;
        }

        function clearValidationErrors() {
            document.querySelectorAll('.validation-error').forEach(el => el.textContent = '');
            document.querySelectorAll('.form-group input, .form-group textarea, .form-group select').forEach(el => el.classList.remove('error'));
        }

       function saveSatellite(event) {
    clearValidationErrors();

    const titleInput = safeGetElement('satellite-title');
    const noradInput = safeGetElement('satellite-norad');

    let valid = true;
    if (!titleInput || !titleInput.value.trim()) {
        showValidationError('title', '‚ùå Name required');
        valid = false;
    }
    if (!noradInput || !noradInput.value.trim()) {
        showValidationError('norad', '‚ùå NORAD ID required');
        valid = false;
    }

    if (!valid) {
        showAlert('‚ùå Please fix errors', 'error');
        return false;
    }

    // Get form data directly from the event target
    const form = event.target;
    if (!form) {
        Logger.error('Cannot access form from event');
        showAlert('‚ùå Form submission error', 'error');
        return false;
    }

    const formData = new FormData(form);
    Logger.log('üìã Form data collected: ' + formData.get('Title'));

    if (config.inSharePoint && config.siteUrl) {
        saveSatelliteToSharePoint(formData);
    } else {
        saveSatelliteToLocalStorage(formData);
    }

    return false;
}


        async function saveSatelliteToSharePoint(formData) {
    try {
        const payload = {
            '__metadata': { 'type': 'SP.Data.Satellite_x005f_FixedListItem' },
            'Title': formData.get('Title').trim(),
            'NORAD_ID': parseFloat(formData.get('NORAD_ID').trim()) || 0,
            'COSPAR_ID': formData.get('COSPAR_ID')?.trim() || '',
            'Mission_Type': formData.get('Mission_Type')?.trim() || '',
            'Status': formData.get('Status') || 'Operational',
            'Orbit_Type': formData.get('Orbit_Type') || '',
            'Launch_Date': formData.get('Launch_Date') ? new Date(formData.get('Launch_Date')).toISOString() : null,
            'Sensor_Names': formData.get('Sensor_Names')?.trim() || ''
        };

        Logger.log('Payload prepared:', JSON.stringify(payload));

        const contextUrl = config.siteUrl + '/_api/contextinfo';
        const digestResponse = await fetch(contextUrl, {
            method: 'POST',
            headers: { 'Accept': 'application/json;odata=verbose' },
            credentials: 'include'
        });

        if (!digestResponse.ok) {
            throw new Error('Failed to get digest token: ' + digestResponse.statusText);
        }

        const digestData = await digestResponse.json();
        const digest = digestData.d.GetContextWebInformation.FormDigestValue;

        const url = config.siteUrl + `/_api/web/lists/getbytitle('${config.satelliteList}')/items` +
            (state.editingId ? `(${state.editingId})` : '');

        Logger.log(`${state.editingId ? 'Updating' : 'Creating'} satellite at: ${url}`);

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Accept': 'application/json;odata=verbose',
                'Content-Type': 'application/json;odata=verbose',
                'X-RequestDigest': digest,
                ...(state.editingId && { 'X-HTTP-Method': 'MERGE', 'IF-MATCH': '*' })
            },
            body: JSON.stringify(payload),
            credentials: 'include'
        });

        const responseText = await response.text();
        Logger.log('Response status: ' + response.status);
        Logger.log('Response body: ' + responseText);

        if (response.ok || response.status === 201 || response.status === 204) {
            showAlert(`‚úÖ ${state.editingId ? 'Updated' : 'Created'} successfully!`, 'success');
            closeAddSatelliteModal();
            await loadSatellites();
            filterAndDisplayData();
            updateStatistics();
        } else {
            // Parse error from SharePoint
            let errorMsg = 'Unknown error';
            try {
                const errorData = JSON.parse(responseText);
                errorMsg = errorData.error?.message?.value || errorData.error?.message || errorMsg;
            } catch (e) {
                errorMsg = responseText || response.statusText;
            }
            throw new Error(`HTTP ${response.status}: ${errorMsg}`);
        }
    } catch (e) {
        Logger.error('Error saving to SharePoint', e.message);
        showAlert('‚ùå Save failed: ' + e.message, 'error');
    }
}


        function saveSatelliteToLocalStorage(formData) {
            const title = formData.get('Title').trim();
            const norad = formData.get('NORAD_ID').trim();

            if (state.editingId) {
                const idx = state.satellites.findIndex(s => s.ID === state.editingId);
                if (idx !== -1) {
                    state.satellites[idx] = {
                        ...state.satellites[idx],
                        Title: title,
                        NORAD_ID: norad,
                        COSPAR_ID: formData.get('COSPAR_ID')?.trim() || '',
                        Mission_Type: formData.get('Mission_Type')?.trim() || '',
                        Status: formData.get('Status') || 'Operational',
                        Orbit_Type: formData.get('Orbit_Type') || '',
                        Launch_Date: formData.get('Launch_Date') || '',
                        Sensor_Names: formData.get('Sensor_Names')?.trim() || ''
                    };
                }
            } else {
                state.satellites.push({
                    ID: state.nextId++,
                    Title: title,
                    NORAD_ID: norad,
                    COSPAR_ID: formData.get('COSPAR_ID')?.trim() || '',
                    Mission_Type: formData.get('Mission_Type')?.trim() || '',
                    Status: formData.get('Status') || 'Operational',
                    Orbit_Type: formData.get('Orbit_Type') || '',
                    Launch_Date: formData.get('Launch_Date') || '',
                    Expected_Lifetime: '',
                    Constellation_ID: 1,
                    Sensor_Names: formData.get('Sensor_Names')?.trim() || '',
                    Primary_Sensor: ''
                });
            }

            saveToLocalStorage();
            showAlert('‚úÖ Saved!', 'success');
            closeAddSatelliteModal();
            filterAndDisplayData();
            updateStatistics();
        }

        function showValidationError(field, msg) {
            const err = safeGetElement(`error-${field}`);
            const inp = safeGetElement(`satellite-${field}`);
            if (err) err.textContent = msg;
            if (inp) inp.classList.add('error');
        }

        function editSatellite(id) {
    const sat = state.satellites.find(s => s.ID === id);
    if (!sat) {
        Logger.error('Satellite not found: ' + id);
        showAlert('‚ùå Satellite not found', 'error');
        return;
    }

    state.editingId = id;

    // Use getElementById instead of querySelector for reliability
    const titleInput = safeGetElement('satellite-title');
    const noradInput = safeGetElement('satellite-norad');
    const cosparInput = safeGetElement('satellite-cospar');
    const missionInput = safeGetElement('satellite-mission');
    const statusInput = safeGetElement('satellite-status');
    const orbitInput = safeGetElement('satellite-orbit');
    const launchInput = safeGetElement('satellite-launch');
    const sensorsInput = safeGetElement('satellite-sensors');

    if (titleInput) titleInput.value = sat.Title || '';
    if (noradInput) noradInput.value = sat.NORAD_ID || '';
    if (cosparInput) cosparInput.value = sat.COSPAR_ID || '';
    if (missionInput) missionInput.value = sat.Mission_Type || '';
    if (statusInput) statusInput.value = sat.Status || 'Operational';
    if (orbitInput) orbitInput.value = sat.Orbit_Type || '';
    if (launchInput) launchInput.value = sat.Launch_Date || '';
    if (sensorsInput) sensorsInput.value = sat.Sensor_Names || '';

    const modalTitle = safeGetElement('modalTitle');
    if (modalTitle) modalTitle.textContent = `Edit: ${sat.Title}`;

    showAddSatelliteModal();
    Logger.log('‚úÖ Edit form populated for ID: ' + id);
}


        function deleteSatellite(id) {
            if (!confirm('Delete this satellite?')) return false;

            if (config.inSharePoint && config.siteUrl) {
                deleteSatelliteFromSharePoint(id);
            } else {
                const idx = state.satellites.findIndex(s => s.ID === id);
                if (idx !== -1) {
                    state.satellites.splice(idx, 1);
                    saveToLocalStorage();
                    state.selectedSatellite = null;
                    filterAndDisplayData();
                    updateStatistics();
                    showAlert('‚úÖ Deleted', 'success');
                }
            }
            return false;
        }

        async function deleteSatelliteFromSharePoint(id) {
            try {
                const contextUrl = config.siteUrl + '/_api/contextinfo';
                const digestResponse = await fetch(contextUrl, {
                    method: 'POST',
                    headers: { 'Accept': 'application/json;odata=verbose' },
                    credentials: 'include'
                });

                if (!digestResponse.ok) throw new Error('Failed to get digest');

                const digestData = await digestResponse.json();
                const digest = digestData.d.GetContextWebInformation.FormDigestValue;

                const url = config.siteUrl + `/_api/web/lists/getbytitle('${config.satelliteList}')/items(${id})`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-RequestDigest': digest,
                        'X-HTTP-Method': 'DELETE',
                        'IF-MATCH': '*'
                    },
                    credentials: 'include'
                });

                if (response.ok || response.status === 204) {
                    showAlert('‚úÖ Deleted', 'success');
                    await loadSatellites();
                    filterAndDisplayData();
                    updateStatistics();
                }
            } catch (e) {
                Logger.error('Error deleting', e.message);
                showAlert('‚ùå Error: ' + e.message, 'error');
            }
        }

        // ============================================================================
        // CSV IMPORT
        // ============================================================================

        function showImportModal() {
            const modal = safeGetElement('importModal');
            if (modal) modal.classList.add('active');
            return false;
        }

        function closeImportModal() {
            const modal = safeGetElement('importModal');
            if (modal) modal.classList.remove('active');
            const file = safeGetElement('csvFile');
            if (file) file.value = '';
            return false;
        }

        function handleCSVFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    state.csvPreviewData = parseCSV(e.target.result);
                    if (state.csvPreviewData.length === 0) {
                        showAlert('‚ùå No data in CSV', 'error');
                        return;
                    }
                    displayCSVPreview(state.csvPreviewData);
                } catch (err) {
                    Logger.error('CSV parsing error', err.message);
                    showAlert('‚ùå Error parsing CSV', 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = parseCSVLine(lines[0]);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((h, idx) => {
                    row[h.trim()] = values[idx] ? values[idx].trim() : '';
                });
                data.push(row);
            }
            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                const next = line[i + 1];

                if (ch === '"') {
                    if (inQuotes && next === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (ch === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += ch;
                }
            }
            result.push(current);
            return result;
        }

        function displayCSVPreview(data) {
            const preview = safeGetElement('importPreview');
            if (!preview) return;

            let html = '<table><thead><tr>';
            if (data.length > 0) {
                Object.keys(data[0]).forEach(k => {
                    html += `<th>${escapeHtml(k)}</th>`;
                });
            }
            html += '</tr></thead><tbody>';

            data.slice(0, 5).forEach(row => {
                html += '<tr>';
                Object.values(row).forEach(v => {
                    html += `<td>${escapeHtml(v)}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            if (data.length > 5) html += `<p>... and ${data.length - 5} more rows</p>`;

            preview.innerHTML = html;
            preview.style.display = 'block';
        }

        function handleCSVImport(event) {
            event.preventDefault();

            if (state.csvPreviewData.length === 0) {
                showAlert('‚ùå No data to import', 'error');
                return false;
            }

            if (config.inSharePoint && config.siteUrl) {
                importCSVToSharePoint();
            } else {
                importCSVToLocalStorage();
            }

            return false;
        }

        async function importCSVToSharePoint() {
            let success = 0;
            try {
                const contextUrl = config.siteUrl + '/_api/contextinfo';
                const digestResponse = await fetch(contextUrl, {
                    method: 'POST',
                    headers: { 'Accept': 'application/json;odata=verbose' },
                    credentials: 'include'
                });

                if (!digestResponse.ok) throw new Error('Failed to get digest');

                const digestData = await digestResponse.json();
                const digest = digestData.d.GetContextWebInformation.FormDigestValue;

                for (const row of state.csvPreviewData) {
                    try {
                        const payload = {
                            '__metadata': { 'type': 'SP.Data.Satellite_x005f_FixedListItem' },
                            'Title': row['Title'] || '',
                            'NORAD_ID': row['NORAD_ID'] || '',
                            'COSPAR_ID': row['COSPAR_ID'] || '',
                            'Mission_Type': row['Mission_Type'] || '',
                            'Status': row['Status'] || 'Operational',
                            'Orbit_Type': row['Orbit_Type'] || '',
                            'Launch_Date': row['Launch_Date'] ? new Date(row['Launch_Date']).toISOString() : null,
                            'Sensor_Names': row['Sensor_Names'] || ''
                        };

                        const url = config.siteUrl + `/_api/web/lists/getbytitle('${config.satelliteList}')/items`;

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json;odata=verbose',
                                'Content-Type': 'application/json;odata=verbose',
                                'X-RequestDigest': digest
                            },
                            body: JSON.stringify(payload),
                            credentials: 'include'
                        });

                        if (response.ok || response.status === 201) success++;
                    } catch (e) {
                        Logger.warn('Failed to import row');
                    }
                }

                showAlert(`‚úÖ Imported ${success} satellites`, 'success');
                closeImportModal();
                await loadSatellites();
                filterAndDisplayData();
            } catch (e) {
                Logger.error('CSV import error', e.message);
                showAlert('‚ùå Error: ' + e.message, 'error');
            }
        }

        function importCSVToLocalStorage() {
            let success = 0;
            for (const row of state.csvPreviewData) {
                try {
                    state.satellites.push({
                        ID: state.nextId++,
                        Title: row['Title'] || '',
                        NORAD_ID: row['NORAD_ID'] || '',
                        COSPAR_ID: row['COSPAR_ID'] || '',
                        Mission_Type: row['Mission_Type'] || '',
                        Status: row['Status'] || 'Operational',
                        Orbit_Type: row['Orbit_Type'] || '',
                        Launch_Date: row['Launch_Date'] || '',
                        Expected_Lifetime: '',
                        Constellation_ID: 1,
                        Sensor_Names: row['Sensor_Names'] || '',
                        Primary_Sensor: ''
                    });
                    success++;
                } catch (e) {
                    Logger.warn('Error importing row');
                }
            }
            saveToLocalStorage();
            showAlert(`‚úÖ Imported ${success} satellites`, 'success');
            closeImportModal();
            filterAndDisplayData();
            updateStatistics();
        }

        // ============================================================================
        // UTILITIES
        // ============================================================================

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return (text || '').toString().replace(/[&<>"']/g, m => map[m]);
        }

        function updateStatistics() {
            const op = state.satellites.filter(s => s.Status === 'Operational').length;
            const cons = new Set(state.satellites.map(s => s.Constellation_ID)).size;

            const els = ['statSatellites', 'statSensors', 'statOperational', 'statConstellations'];
            const vals = [state.satellites.length, state.sensors.length, op, cons];
            els.forEach((id, idx) => {
                const el = safeGetElement(id);
                if (el) el.textContent = vals[idx];
            });
        }

        function sortTable(type, col) {
            if (state.sortColumn === col) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortColumn = col;
                state.sortDirection = 'asc';
            }
            filterAndDisplayData();
        }

        function switchTab(type, tab) {
            state.currentFilter = tab;
            filterAndDisplayData();
            return false;
        }

        function showAlert(msg, type = 'info') {
            const container = safeGetElement('alertContainer');
            if (!container) return;
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<span>${escapeHtml(msg)}</span>`;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }

        function exportToCSV() {
            const data = state.filteredSatellites.map(s => ({
                Title: s.Title,
                NORAD_ID: s.NORAD_ID,
                COSPAR_ID: s.COSPAR_ID,
                Mission_Type: s.Mission_Type,
                Status: s.Status,
                Orbit_Type: s.Orbit_Type,
                Launch_Date: s.Launch_Date,
                Sensor_Names: s.Sensor_Names
            }));

            if (data.length === 0) {
                showAlert('No data to export', 'error');
                return false;
            }

            const csv = [
                Object.keys(data[0]).join(','),
                ...data.map(r => Object.values(r).map(v => `"${(v || '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'satellites.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            return false;
        }

// Temporary debug helper
window.debugSatelliteForm = function() {
    console.log('=== Form Debug Info ===');
    console.log('EditingId:', state.editingId);
    console.log('Title:', safeGetElement('satellite-title')?.value);
    console.log('NORAD:', safeGetElement('satellite-norad')?.value);
    console.log('Status:', safeGetElement('satellite-status')?.value);
    console.log('Form element:', safeGetElement('satelliteForm'));
    console.log('Modal visible:', safeGetElement('addSatelliteModal')?.classList.contains('active'));
};

    </script>
</body>
</html>
