<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite Sensor Survey v5 - Fixed for iframe</title>
    <style>
        :root {
            --color-primary: #2180A3;
            --color-primary-hover: #1D6E80;
            --color-success: #32B8C6;
            --color-error: #C0152F;
            --color-warning: #A84B2F;
            --color-bg: #FCFCF9;
            --color-surface: #FFFFFF;
            --color-text: #134252;
            --color-text-secondary: #628076;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-shadow: rgba(0, 0, 0, 0.08);
            --radius: 8px;
            --spacing: 16px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing);
        }

        header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--spacing) 0;
            margin-bottom: var(--spacing);
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            color: var(--color-primary);
        }

        .header-subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing);
            margin-bottom: var(--spacing);
        }

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: var(--spacing);
            text-align: center;
            box-shadow: 0 2px 4px var(--color-shadow);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: var(--color-primary);
            margin: 8px 0;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toolbar {
            display: flex;
            gap: var(--spacing);
            margin-bottom: var(--spacing);
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            display: flex;
            gap: 8px;
        }

        .search-box input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            font-size: 14px;
            background: var(--color-surface);
            color: var(--color-text);
        }

        .search-box input::placeholder {
            color: var(--color-text-secondary);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 150ms ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            box-shadow: 0 4px 8px rgba(33, 128, 141, 0.2);
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        .btn-secondary:hover {
            background: rgba(33, 128, 141, 0.05);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing);
            margin-bottom: var(--spacing);
        }

        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: var(--spacing);
            box-shadow: 0 2px 4px var(--color-shadow);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing);
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 12px;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--color-primary);
        }

        .filter-group {
            display: flex;
            gap: 8px;
            margin-bottom: var(--spacing);
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 12px;
            transition: all 150ms ease;
            color: var(--color-text);
        }

        .filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .filter-btn:hover {
            border-color: var(--color-primary);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-surface);
        }

        thead {
            background: rgba(33, 128, 141, 0.08);
            border-bottom: 2px solid var(--color-border);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: var(--color-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: rgba(33, 128, 141, 0.12);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
            font-size: 13px;
        }

        tbody tr {
            transition: background 150ms ease;
        }

        tbody tr:hover {
            background: rgba(33, 128, 141, 0.04);
            cursor: pointer;
        }

        tbody tr.selected {
            background: rgba(33, 128, 141, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-operational {
            background: rgba(50, 184, 198, 0.2);
            color: var(--color-success);
        }

        .badge-testing {
            background: rgba(230, 129, 97, 0.2);
            color: var(--color-warning);
        }

        .badge-decommissioned {
            background: rgba(192, 21, 47, 0.2);
            color: var(--color-error);
        }

        .detail-view {
            display: grid;
            gap: 12px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 12px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--color-primary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            color: var(--color-text);
            font-size: 14px;
            word-break: break-word;
        }

        .sensors-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding-top: 6px;
        }

        .sensor-tag {
            background: rgba(33, 128, 141, 0.15);
            color: var(--color-primary);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
        }

        .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    overflow: auto;
}

        .modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

        .modal-content {
    background-color: var(--color-surface);
    padding: var(--space-24);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing);
            padding-bottom: var(--spacing);
            border-bottom: 1px solid var(--color-border);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--color-primary);
        }
		.modal h2 {
    margin-top: 0;
    margin-bottom: var(--space-16);
}


        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        .modal-close:hover {
            color: var(--color-text);
        }

        .form-group {
            margin-bottom: var(--spacing);
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--color-text);
            font-size: 13px;
        }
.form-actions {
    display: flex;
    gap: var(--space-12);
    margin-top: var(--space-20);
}

.form-actions button {
    flex: 1;
}
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: inherit;
            color: var(--color-text);
            background: var(--color-bg);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: var(--spacing);
            padding-top: var(--spacing);
            border-top: 1px solid var(--color-border);
        }

        .empty-state {
            text-align: center;
            padding: 40px var(--spacing);
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(33, 128, 141, 0.2);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: var(--spacing);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 300ms ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: rgba(50, 184, 198, 0.1);
            color: var(--color-success);
            border: 1px solid rgba(50, 184, 198, 0.3);
        }

        .alert-error {
            background: rgba(192, 21, 47, 0.1);
            color: var(--color-error);
            border: 1px solid rgba(192, 21, 47, 0.3);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--color-border);
            margin-bottom: var(--spacing);
            gap: 4px;
        }

        .tab-btn {
            padding: 12px 16px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            font-weight: 500;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            transition: all 150ms ease;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üõ∞Ô∏è Satellite Sensor Survey</h1>
            <p class="header-subtitle">Real-time satellite and sensor management dashboard</p>
        </div>
    </header>

    <main class="container">
        <!-- Alerts -->
        <div id="alertContainer"></div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Satellites</div>
                <div class="stat-value" id="statSatellites">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Sensors</div>
                <div class="stat-value" id="statSensors">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Operational</div>
                <div class="stat-value" id="statOperational">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Constellations</div>
                <div class="stat-value" id="statConstellations">0</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search satellites, sensors, or NORAD IDs...">
            </div>
            <button class="btn btn-primary" onclick="showAddSatelliteModal()">+ Add Satellite</button>
            <button class="btn btn-secondary" onclick="exportToCSV()">üì• Export</button>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Satellites Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>Satellites</h2>
                    <span id="satelliteCount">0</span>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('satellites', 'sat-all')">All</button>
                    <button class="tab-btn" onclick="switchTab('satellites', 'sat-operational')">Operational</button>
                    <button class="tab-btn" onclick="switchTab('satellites', 'sat-leo')">LEO</button>
                    <button class="tab-btn" onclick="switchTab('satellites', 'sat-geo')">GEO</button>
                </div>

                <div class="table-wrapper">
                    <table id="satelliteTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('satellites', 'Title')">Name ‚Üï</th>
                                <th onclick="sortTable('satellites', 'NORAD_ID')">NORAD ID ‚Üï</th>
                                <th>Status</th>
                                <th>Orbit</th>
                            </tr>
                        </thead>
                        <tbody id="satelliteTableBody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: #999;">
                                    <div class="loading"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sensors Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>Sensors</h2>
                    <span id="sensorCount">0</span>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('sensors', 'sen-all')">All</button>
                    <button class="tab-btn" onclick="switchTab('sensors', 'sen-eo')">EO</button>
                    <button class="tab-btn" onclick="switchTab('sensors', 'sen-ir')">IR</button>
                    <button class="tab-btn" onclick="switchTab('sensors', 'sen-sar')">SAR</button>
                </div>

                <div class="table-wrapper">
                    <table id="sensorTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('sensors', 'Title')">Name ‚Üï</th>
                                <th>Type</th>
                                <th>Satellites</th>
                            </tr>
                        </thead>
                        <tbody id="sensorTableBody">
                            <tr>
                                <td colspan="3" style="text-align: center; color: #999;">
                                    <div class="loading"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Detail View -->
        <div class="panel">
            <div class="panel-header">
                <h2 id="detailTitle">Satellite Details</h2>
                <div id="detailActions"></div>
            </div>
            <div id="detailContent" class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <p>Select a satellite or sensor to view details</p>
            </div>
        </div>
    </main>

    <!-- Add/Edit Modal -->
    <!-- Modal Form - Make sure it's properly closed and has correct attributes -->
<div id="addSatelliteModal" class="modal">
    <div class="modal-content">
        <h2>Add New Satellite</h2>
        
        <form id="satelliteForm" onsubmit="saveSatellite(event)">
            <!-- Wrap form inputs to prevent browser validation conflicts -->
            
            <div class="form-group">
                <label for="satellite-title" class="form-label">Satellite Name *</label>
                <input 
                    type="text" 
                    id="satellite-title"
                    name="Title" 
                    class="form-control" 
                    required
                    placeholder="Enter satellite name"
                >
            </div>

            <div class="form-group">
                <label for="satellite-norad" class="form-label">NORAD ID *</label>
                <input 
                    type="number" 
                    id="satellite-norad"
                    name="NORAD_ID" 
                    class="form-control" 
                    required
                    placeholder="Enter NORAD ID"
                >
            </div>

            <div class="form-group">
                <label for="satellite-cospar" class="form-label">COSPAR ID</label>
                <input 
                    type="text" 
                    id="satellite-cospar"
                    name="COSPAR_ID" 
                    class="form-control"
                    placeholder="e.g., 2013-008A"
                >
            </div>

            <div class="form-group">
                <label for="satellite-mission" class="form-label">Mission Type</label>
                <input 
                    type="text" 
                    id="satellite-mission"
                    name="Mission_Type" 
                    class="form-control"
                    placeholder="e.g., Earth Observation"
                >
            </div>

            <div class="form-group">
                <label for="satellite-status" class="form-label">Status</label>
                <select id="satellite-status" name="Status" class="form-control">
                    <option value="Operational">Operational</option>
                    <option value="Non-operational">Non-operational</option>
                    <option value="Partially operational">Partially operational</option>
                    <option value="Unknown">Unknown</option>
                </select>
            </div>

            <div class="form-group">
                <label for="satellite-orbit" class="form-label">Orbit Type</label>
                <select id="satellite-orbit" name="Orbit_Type" class="form-control">
                    <option value="">-- Select --</option>
                    <option value="LEO">LEO</option>
                    <option value="MEO">MEO</option>
                    <option value="GEO">GEO</option>
                    <option value="SSO">SSO</option>
                </select>
            </div>

            <div class="form-group">
                <label for="satellite-launch" class="form-label">Launch Date</label>
                <input 
                    type="date" 
                    id="satellite-launch"
                    name="Launch_Date" 
                    class="form-control"
                >
            </div>

            <div class="form-group">
                <label for="satellite-sensors" class="form-label">Sensor Names</label>
                <textarea 
                    id="satellite-sensors"
                    name="Sensor_Names" 
                    class="form-control" 
                    rows="3"
                    placeholder="Comma-separated sensor names"
                ></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddSatelliteModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>


    <script>
        // ============================================================================
        // SATELLITE SENSOR SURVEY v5 - FIXED FOR IFRAME
        // ============================================================================

        // Configuration - IMPORTANT: Update siteUrl with your SharePoint site URL
        const config = {
            satelliteList: 'Satellite_Fixed',
            sensorList: 'Sensor',
            useMultiSelectChoice: false,
            inSharePoint: window._spPageContextInfo !== undefined,
            siteUrl: _spPageContextInfo.webAbsoluteUrl  // ‚Üê UPDATE THIS WITH YOUR SITE URL
        };

        // State Management
        const state = {
            satellites: [],
            sensors: [],
            filteredSatellites: [],
            filteredSensors: [],
            selectedSatellite: null,
            selectedSensor: null,
            searchTerm: '',
            sortColumn: 'Title',
            sortDirection: 'asc',
            currentFilter: 'all',
			editingId: null
        };

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Initializing Satellite Sensor Survey v5...');
            console.log('SharePoint Context:', config.inSharePoint ? 'Detected' : 'Not Detected (Using Sample Data)');
            console.log('Site URL:', config.siteUrl);

            // Load data
            await loadSatellites();
            await loadSensors();

            // Set up event listeners
            document.getElementById('searchInput').addEventListener('input', (e) => {
                state.searchTerm = e.target.value.toLowerCase();
                filterAndDisplayData();
            });

            // Initial render
            filterAndDisplayData();
            updateStatistics();
        });

        // ============================================================================
        // DATA LOADING - SHAREPOINT REST API (FIXED VERSION)
        // ============================================================================

        async function loadSatellites() {
            try {
                if (config.inSharePoint) {
                    // NEW METHOD: Direct API call without request digest
                    const url = config.siteUrl + 
                        `/_api/web/lists/getbytitle('${config.satelliteList}')/items?` +
                        `$select=ID,Title,NORAD_ID,COSPAR_ID,Mission_Type,Status,Orbit_Type,` +
                        `Launch_Date,Expected_Lifetime,Constellation_ID,Sensor_Names,Primary_Sensor&` +
                        `$top=5000`;

                    console.log('Fetching satellites from:', url);

                    const response = await fetch(url, {
    method: 'GET',
    headers: {
        'Accept': 'application/json;odata=verbose'
    }
});

                    if (response.ok) {
                        const data = await response.json();
                        state.satellites = data.d.results.map(item => ({
                            ID: item.ID,
                            Title: item.Title || '',
                            NORAD_ID: item.NORAD_ID || '',
                            COSPAR_ID: item.COSPAR_ID || '',
                            Mission_Type: item.Mission_Type || '',
                            Status: item.Status || 'Operational',
                            Orbit_Type: item.Orbit_Type || '',
                            Launch_Date: item.Launch_Date ? new Date(item.Launch_Date).toISOString().split('T')[0] : '',
                            Expected_Lifetime: item.Expected_Lifetime || '',
                            Constellation_ID: item.Constellation_ID || '',
                            Sensor_Names: item.Sensor_Names || '',
                            Primary_Sensor: item.Primary_Sensor || ''
                        }));
                        showAlert('‚úÖ Satellites loaded from SharePoint', 'success');
                        console.log('Loaded ' + state.satellites.length + ' satellites');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } else {
                    // Sample data fallback
                    state.satellites = [
                        { ID: 1, Title: 'Landsat 8', NORAD_ID: 39084, COSPAR_ID: '2013-008A', Mission_Type: 'Earth Observation', Status: 'Operational', Orbit_Type: 'SSO', Launch_Date: '2013-02-11', Expected_Lifetime: 10, Constellation_ID: 1, Sensor_Names: 'Multispectral Imager,Optical Imager', Primary_Sensor: 'Multispectral Imager' },
                        { ID: 2, Title: 'Sentinel-1A', NORAD_ID: 39953, COSPAR_ID: '2014-016A', Mission_Type: 'Earth Observation', Status: 'Operational', Orbit_Type: 'SSO', Launch_Date: '2014-04-03', Expected_Lifetime: 7, Constellation_ID: 2, Sensor_Names: 'SAR-X', Primary_Sensor: 'SAR-X' },
                        { ID: 3, Title: 'Sentinel-2A', NORAD_ID: 40697, COSPAR_ID: '2015-028A', Mission_Type: 'Earth Observation', Status: 'Operational', Orbit_Type: 'SSO', Launch_Date: '2015-06-23', Expected_Lifetime: 7.25, Constellation_ID: 2, Sensor_Names: 'Multispectral Imager,Optical Imager', Primary_Sensor: 'Multispectral Imager' },
                        { ID: 4, Title: 'NOAA-18', NORAD_ID: 28654, COSPAR_ID: '2005-018A', Mission_Type: 'METOC', Status: 'Operational', Orbit_Type: 'SSO', Launch_Date: '2005-05-20', Expected_Lifetime: 14, Constellation_ID: 3, Sensor_Names: 'Radiometer,Thermal IR Camera', Primary_Sensor: 'Radiometer' }
                    ];
                    showAlert('üìä Using sample satellite data', 'success');
                }
            } catch (error) {
                console.error('Error loading satellites:', error);
                showAlert('Error loading satellites: ' + error.message, 'error');
            }
        }

        async function loadSensors() {
            try {
                if (config.inSharePoint) {
                    // NEW METHOD: Direct API call without request digest
                    const url = config.siteUrl + 
                        `/_api/web/lists/getbytitle('${config.sensorList}')/items?` +
                        `$select=ID,Title,Sensor_Type,Description,N_of_Bands,` +
                        `Resolution_Min_m,Resolution_Max_m,Swath_Min_km,Swath_Max_km,Satellite_Names&` +
                        `$top=5000`;

                    console.log('Fetching sensors from:', url);

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json;odata=verbose'
                        },
                        credentials: 'include'  // Include SharePoint cookies
                    });

                    if (response.ok) {
                        const data = await response.json();
                        state.sensors = data.d.results.map(item => ({
                            ID: item.ID,
                            Title: item.Title || '',
                            Sensor_Type: item.Sensor_Type || '',
                            Description: item.Description || '',
                            N_of_Bands: item.N_of_Bands || '',
                            Resolution_Min_m: item.Resolution_Min_m || '',
                            Resolution_Max_m: item.Resolution_Max_m || '',
                            Swath_Min_km: item.Swath_Min_km || '',
                            Swath_Max_km: item.Swath_Max_km || '',
                            Satellite_Names: item.Satellite_Names || ''
                        }));
                        showAlert('‚úÖ Sensors loaded from SharePoint', 'success');
                        console.log('Loaded ' + state.sensors.length + ' sensors');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } else {
                    // Sample data fallback
                    state.sensors = [
                        { ID: 1, Title: 'VIIRS', Sensor_Type: 'Multispectral', Description: 'Visible Infrared Imaging Radiometer Suite', N_of_Bands: 22, Resolution_Min_m: 375, Resolution_Max_m: 750, Swath_Min_km: 3000, Swath_Max_km: 3000, Satellite_Names: 'Landsat 8, Sentinel-2A' },
                        { ID: 2, Title: 'SAR-X', Sensor_Type: 'SAR', Description: 'Synthetic Aperture Radar X-band', N_of_Bands: 1, Resolution_Min_m: 3, Resolution_Max_m: 10, Swath_Min_km: 100, Swath_Max_km: 300, Satellite_Names: 'Sentinel-1A' },
                        { ID: 3, Title: 'Radiometer', Sensor_Type: 'Thermal', Description: 'Advanced Very High Resolution Radiometer', N_of_Bands: 5, Resolution_Min_m: 1000, Resolution_Max_m: 1000, Swath_Min_km: 2400, Swath_Max_km: 2400, Satellite_Names: 'NOAA-18' }
                    ];
                    showAlert('üìä Using sample sensor data', 'success');
                }
            } catch (error) {
                console.error('Error loading sensors:', error);
                showAlert('Error loading sensors: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // DATA FILTERING AND DISPLAY
        // ============================================================================

        function filterAndDisplayData() {
            // Filter satellites
            state.filteredSatellites = state.satellites.filter(sat => {
                const matchesSearch = !state.searchTerm ||
                    sat.Title.toLowerCase().includes(state.searchTerm) ||
                    (sat.NORAD_ID && sat.NORAD_ID.toString().includes(state.searchTerm)) ||
                    (sat.Mission_Type && sat.Mission_Type.toLowerCase().includes(state.searchTerm));

                if (state.currentFilter === 'sat-operational') {
                    return matchesSearch && sat.Status === 'Operational';
                } else if (state.currentFilter === 'sat-leo') {
                    return matchesSearch && sat.Orbit_Type === 'LEO';
                } else if (state.currentFilter === 'sat-geo') {
                    return matchesSearch && sat.Orbit_Type === 'GEO';
                }

                return matchesSearch;
            });

            // Filter sensors
            state.filteredSensors = state.sensors.filter(sen => {
                const matchesSearch = !state.searchTerm ||
                    sen.Title.toLowerCase().includes(state.searchTerm) ||
                    (sen.Sensor_Type && sen.Sensor_Type.toLowerCase().includes(state.searchTerm));

                if (state.currentFilter === 'sen-eo') {
                    return matchesSearch && sen.Sensor_Type === 'EO';
                } else if (state.currentFilter === 'sen-ir') {
                    return matchesSearch && sen.Sensor_Type === 'IR';
                } else if (state.currentFilter === 'sen-sar') {
                    return matchesSearch && sen.Sensor_Type === 'SAR';
                }

                return matchesSearch;
            });

            // Sort
            state.filteredSatellites.sort((a, b) => {
                let aVal = a[state.sortColumn] || '';
                let bVal = b[state.sortColumn] || '';
                const comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                return state.sortDirection === 'asc' ? comparison : -comparison;
            });

            state.filteredSensors.sort((a, b) => {
                let aVal = a[state.sortColumn] || '';
                let bVal = b[state.sortColumn] || '';
                const comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                return state.sortDirection === 'asc' ? comparison : -comparison;
            });

            renderSatelliteTable();
            renderSensorTable();

            document.getElementById('satelliteCount').textContent = state.filteredSatellites.length;
            document.getElementById('sensorCount').textContent = state.filteredSensors.length;
        }

        function renderSatelliteTable() {
            const tbody = document.getElementById('satelliteTableBody');
            
            if (state.filteredSatellites.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No satellites found</td></tr>';
                return;
            }

            tbody.innerHTML = state.filteredSatellites.map(sat => `
                <tr onclick="selectSatellite(${sat.ID})" class="${state.selectedSatellite?.ID === sat.ID ? 'selected' : ''}">
                    <td><strong>${sat.Title}</strong></td>
                    <td>${sat.NORAD_ID}</td>
                    <td><span class="badge badge-${sat.Status.toLowerCase()}">${sat.Status}</span></td>
                    <td>${sat.Orbit_Type}</td>
                </tr>
            `).join('');
        }

        function renderSensorTable() {
            const tbody = document.getElementById('sensorTableBody');
            
            if (state.filteredSensors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No sensors found</td></tr>';
                return;
            }

            tbody.innerHTML = state.filteredSensors.map(sen => `
                <tr onclick="selectSensor(${sen.ID})" class="${state.selectedSensor?.ID === sen.ID ? 'selected' : ''}">
                    <td><strong>${sen.Title}</strong></td>
                    <td>${sen.Sensor_Type}</td>
                    <td>${(sen.Satellite_Names || '').split(',').filter(s => s.trim()).length}</td>
                </tr>
            `).join('');
        }

        // ============================================================================
        // DETAIL VIEWS
        // ============================================================================

        function selectSatellite(id) {
            const sat = state.satellites.find(s => s.ID === id);
            if (!sat) return;

            state.selectedSatellite = sat;
            state.selectedSensor = null;

            renderSatelliteDetail();
            filterAndDisplayData();
        }

        function selectSensor(id) {
            const sen = state.sensors.find(s => s.ID === id);
            if (!sen) return;

            state.selectedSensor = sen;
            state.selectedSatellite = null;

            renderSensorDetail();
            filterAndDisplayData();
        }

        function renderSatelliteDetail() {
            const sat = state.selectedSatellite;
            const sensors = (sat.Sensor_Names || '').split(',').map(s => s.trim()).filter(s => s);

            let html = `
                <div class="detail-view">
                    <div class="detail-row">
                        <div class="detail-label">Name</div>
                        <div class="detail-value">${sat.Title}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">NORAD ID</div>
                        <div class="detail-value">${sat.NORAD_ID}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">COSPAR ID</div>
                        <div class="detail-value">${sat.COSPAR_ID || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Status</div>
                        <div class="detail-value"><span class="badge badge-${sat.Status.toLowerCase()}">${sat.Status}</span></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Mission Type</div>
                        <div class="detail-value">${sat.Mission_Type || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Orbit Type</div>
                        <div class="detail-value">${sat.Orbit_Type || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Launch Date</div>
                        <div class="detail-value">${sat.Launch_Date || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Constellation</div>
                        <div class="detail-value">C-${sat.Constellation_ID}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Sensors</div>
                        <div class="detail-value">
                            <div class="sensors-list">
                                ${sensors.length > 0 ? sensors.map(s => `<span class="sensor-tag">${s}</span>`).join('') : '<span style="color: #999;">None assigned</span>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('detailTitle').textContent = `Satellite: ${sat.Title}`;
            document.getElementById('detailContent').innerHTML = html;
            document.getElementById('detailActions').innerHTML = `
                <button class="btn btn-small btn-secondary" onclick="editSatellite(${sat.ID})">Edit</button>
                <button class="btn btn-small btn-secondary" onclick="deleteSatellite(${sat.ID})">Delete</button>
            `;
        }

        function renderSensorDetail() {
            const sen = state.selectedSensor;
            const satellites = (sen.Satellite_Names || '').split(',').map(s => s.trim()).filter(s => s);

            let html = `
                <div class="detail-view">
                    <div class="detail-row">
                        <div class="detail-label">Name</div>
                        <div class="detail-value">${sen.Title}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Type</div>
                        <div class="detail-value">${sen.Sensor_Type || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Description</div>
                        <div class="detail-value">${sen.Description || 'N/A'}</div>
                    </div>
                    ${sen.N_of_Bands ? `
                    <div class="detail-row">
                        <div class="detail-label">Bands</div>
                        <div class="detail-value">${sen.N_of_Bands}</div>
                    </div>
                    ` : ''}
                    ${sen.Resolution_Min_m ? `
                    <div class="detail-row">
                        <div class="detail-label">Resolution</div>
                        <div class="detail-value">${sen.Resolution_Min_m} - ${sen.Resolution_Max_m} m</div>
                    </div>
                    ` : ''}
                    ${sen.Swath_Min_km ? `
                    <div class="detail-row">
                        <div class="detail-label">Swath</div>
                        <div class="detail-value">${sen.Swath_Min_km} - ${sen.Swath_Max_km} km</div>
                    </div>
                    ` : ''}
                    <div class="detail-row">
                        <div class="detail-label">Satellites</div>
                        <div class="detail-value">
                            <div class="sensors-list">
                                ${satellites.length > 0 ? satellites.map(s => `<span class="sensor-tag">${s}</span>`).join('') : '<span style="color: #999;">None assigned</span>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('detailTitle').textContent = `Sensor: ${sen.Title}`;
            document.getElementById('detailContent').innerHTML = html;
            document.getElementById('detailActions').innerHTML = '';
        }

        // ============================================================================
        // CRUD OPERATIONS
        // ============================================================================

        function showAddSatelliteModal() {
    document.getElementById('satelliteForm').reset();
    document.getElementById('addSatelliteModal').querySelector('h2').textContent = 
        'Add New Satellite';
    state.editingId = null;
    document.getElementById('addSatelliteModal').classList.add('active');
}


        function closeAddSatelliteModal() {
    document.getElementById('addSatelliteModal').classList.remove('active');
    document.getElementById('satelliteForm').reset();
    
    // Reset modal title and editing state
    document.getElementById('addSatelliteModal').querySelector('h2').textContent = 
        'Add New Satellite';
    state.editingId = null;
}


async function saveSatellite(event) {
    event.preventDefault();

    const form = document.getElementById('satelliteForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    // Manual validation (bypasses browser validation issues)
    if (!data.Title || data.Title.trim() === '') {
        showAlert('‚ùå Satellite Name is required', 'error');
        return;
    }

    if (!data.NORAD_ID || isNaN(parseInt(data.NORAD_ID))) {
        showAlert('‚ùå NORAD ID is required and must be a number', 'error');
        return;
    }

    if (!config.inSharePoint) {
        showAlert('‚ö†Ô∏è Save operation requires SharePoint context', 'error');
        return;
    }

    try {
        console.log('Attempting to save satellite:', data.Title);

        // Get request digest for POST operation
        const contextUrl = config.siteUrl + '/_api/contextinfo';
        console.log('Getting digest from:', contextUrl);

        const digestResponse = await fetch(contextUrl, {
            method: 'POST',
            headers: { 
                'Accept': 'application/json;odata=verbose'
            }
        });

        if (!digestResponse.ok) {
            throw new Error(`Digest request failed: HTTP ${digestResponse.status}`);
        }

        const digestData = await digestResponse.json();
        const digest = digestData.d.GetContextWebInformation.FormDigestValue;
        console.log('Got digest, saving item...');

        const payload = {
            '__metadata': { 
                'type': 'SP.Data.Satellite_x005f_FixedListItem'
            },
            'Title': data.Title.trim(),
            'NORAD_ID': parseInt(data.NORAD_ID),
            'COSPAR_ID': data.COSPAR_ID ? data.COSPAR_ID.trim() : '',
            'Mission_Type': data.Mission_Type ? data.Mission_Type.trim() : '',
            'Status': data.Status || 'Operational',
            'Orbit_Type': data.Orbit_Type || '',
            'Launch_Date': data.Launch_Date ? new Date(data.Launch_Date).toISOString() : null,
            'Sensor_Names': data.Sensor_Names ? data.Sensor_Names.trim() : ''
        };

        let url, method, headers;

        if (state.editingId) {
            // UPDATE
            console.log(`Updating satellite ID: ${state.editingId}`);

            url = config.siteUrl + 
                `/_api/web/lists/getbytitle('${config.satelliteList}')/items(${state.editingId})`;

            method = 'POST';
            headers = {
                'Accept': 'application/json;odata=verbose',
                'Content-Type': 'application/json;odata=verbose',
                'X-RequestDigest': digest,
                'X-HTTP-Method': 'MERGE',
                'IF-MATCH': '*'
            };

        } else {
            // CREATE
            console.log('Creating new satellite');

            url = config.siteUrl + 
                `/_api/web/lists/getbytitle('${config.satelliteList}')/items`;

            method = 'POST';
            headers = {
                'Accept': 'application/json;odata=verbose',
                'Content-Type': 'application/json;odata=verbose',
                'X-RequestDigest': digest
            };
        }

        console.log(`${state.editingId ? 'UPDATE' : 'CREATE'} URL:`, url);
        console.log('Payload:', payload);

        const response = await fetch(url, {
            method: method,
            headers: headers,
            body: JSON.stringify(payload)
        });

        if (response.ok || response.status === 201 || response.status === 204) {
            const action = state.editingId ? 'updated' : 'added';
            showAlert(`‚úÖ Satellite ${action} successfully!`, 'success');
            
            closeAddSatelliteModal();
            form.reset();
            state.editingId = null;
            
            await loadSatellites();
            filterAndDisplayData();
            updateStatistics();
        } else {
            const errorText = await response.text();
            console.error('API error response:', errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error saving satellite:', error);
        showAlert('‚ùå Error: ' + error.message, 'error');
    }
}



async function deleteSatellite(id) {
    if (!confirm('Are you sure you want to delete this satellite?')) return;

    if (!config.inSharePoint) {
        showAlert('Delete operation requires SharePoint context', 'error');
        return;
    }

    try {
        console.log('Deleting satellite ID:', id);

        // Get request digest for DELETE operation
        const contextUrl = config.siteUrl + '/_api/contextinfo';
        const digestResponse = await fetch(contextUrl, {
            method: 'POST',
            headers: { 
                'Accept': 'application/json;odata=verbose'
            },
            credentials: 'include'
        });

        if (!digestResponse.ok) {
            throw new Error('Failed to get request digest');
        }

        const digestData = await digestResponse.json();
        const digest = digestData.d.GetContextWebInformation.FormDigestValue;

        const url = config.siteUrl + 
            `/_api/web/lists/getbytitle('${config.satelliteList}')/items(${id})`;

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-RequestDigest': digest,
                'X-HTTP-Method': 'DELETE',
                'IF-MATCH': '*',
                'Accept': 'application/json;odata=verbose'
            },
            credentials: 'include'
        });

        if (response.ok || response.status === 204) {
            showAlert('‚úÖ Satellite deleted successfully', 'success');
            state.selectedSatellite = null;
            await loadSatellites();
            filterAndDisplayData();
            updateStatistics();
        } else {
            throw new Error(`HTTP ${response.status}: Failed to delete satellite`);
        }
    } catch (error) {
        console.error('Error deleting satellite:', error);
        showAlert('‚ùå Error: ' + error.message, 'error');
    }
}

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        function updateStatistics() {
            const operational = state.satellites.filter(s => s.Status === 'Operational').length;
            const constellations = new Set(state.satellites.map(s => s.Constellation_ID)).size;

            document.getElementById('statSatellites').textContent = state.satellites.length;
            document.getElementById('statSensors').textContent = state.sensors.length;
            document.getElementById('statOperational').textContent = operational;
            document.getElementById('statConstellations').textContent = constellations;
        }

        function sortTable(type, column) {
            if (state.sortColumn === column) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortColumn = column;
                state.sortDirection = 'asc';
            }
            filterAndDisplayData();
        }

        function switchTab(panelType, tab) {
            state.currentFilter = tab;
            
            const panels = document.querySelectorAll(panelType === 'satellites' ? '.panel:first-of-type .tab-btn' : '.panel:nth-of-type(2) .tab-btn');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            filterAndDisplayData();
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<span>${message}</span>`;
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 4000);
        }

        function exportToCSV() {
            const data = state.filteredSatellites.map(sat => ({
                'Name': sat.Title,
                'NORAD ID': sat.NORAD_ID,
                'Status': sat.Status,
                'Orbit': sat.Orbit_Type,
                'Mission Type': sat.Mission_Type,
                'Sensors': sat.Sensor_Names
            }));

            const csv = [
                Object.keys(data[0]).join(','),
                ...data.map(row => Object.values(row).map(v => `"${v}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'satellites.csv';
            a.click();
        }

function editSatellite(id) {
    const sat = state.satellites.find(s => s.ID === id);
    if (!sat) return;

    // ‚Üê SET EDITING MODE
    state.editingId = id;

    const form = document.getElementById('satelliteForm');
    form.Title.value = sat.Title;
    form.NORAD_ID.value = sat.NORAD_ID;
    form.COSPAR_ID.value = sat.COSPAR_ID;
    form.Mission_Type.value = sat.Mission_Type;
    form.Status.value = sat.Status;
    form.Orbit_Type.value = sat.Orbit_Type;
    form.Launch_Date.value = sat.Launch_Date;
    form.Sensor_Names.value = sat.Sensor_Names;

    // Update modal title to show editing mode
    document.getElementById('addSatelliteModal').querySelector('h2').textContent = 
        `Edit Satellite: ${sat.Title}`;

    showAddSatelliteModal();
}

    </script>
</body>
</html>
